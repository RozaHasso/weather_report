<html>

<head>
    <title>Weather Wep Page</title>
    <style>
        td {
            width: 40px;
            height: 40px;
            border: 1px solid black;
        }

        table {
            border: 1px solid black;
            border-spacing: 0;
        }
    </style>

    <script type='module'>


        import view from './view.js'
        import dataModel from './dataModel.js'

        window.init = function () {
            const request = new XMLHttpRequest()
            request.responseType = 'json';
            //1) first query, request for weather data
            request.open('GET', 'http://localhost:8080/data')
            request.send()
            request.onload = () => {

                const data = request.response
                //1) first query, request for forecast
                request.open('GET', 'http://localhost:8080/forecast')
                request.send()

                request.onload = () => {

                    const forecast = request.response
                    //2) second query, request
                    request.open('GET', 'http://localhost:8080/data')
                    request.send()
                    var latestDate = new Date(Math.max.apply(null, data.map(e => { return new Date(e.time) })));
                    var latestData = data.filter(e => { var d = new Date(e.time); return d.getTime() == latestDate.getTime() })

                    var latestDate2 = new Date(Math.max.apply(null, forecast.map(e => { return new Date(e.time) })));
                    var latestData = forecast.filter(e => { var d = new Date(e.time); return d.getTime() == latestDate2.getTime() })


                    request.onload = () => {

                        const last5MinTempData = request.response
                        const for5Days = () => {
                            const date = new Date();
                            const ts = date.getTime();
                            const fiveDays = ts - (6 * 24 * 60 * 60 * 1000);
                            return new Date(fiveDays)
                        }
                        const last5daysObject = last5MinTempData.filter(e => { var d = new Date(e.time); return d.getDate() > for5Days().getDate() })
                        const temp = last5daysObject.filter(t => t.type === 'temperature')
                        const final = temp.reduce((op, { value, type, unit, time, place }) => {
                            const [date] = time.split('T', 1)
                            op[date] = op[date] || { value: Infinity, type, unit, time, place }
                            op[date].value = op[date].value > value ? value : op[date].value
                            return op
                        }, {})

                        console.log(Object.values(final))


                        const theModel = dataModel(latestData, latestData, Object.values(final))
                        const theView = view(window)
                        theView.update(theModel)
                    }

                }
            }

            /* window.init = function () {
 
                const request = new XMLHttpRequest()
                request.open('GET', 'http://localhost:8080/data')
                request.responseType = 'json';
                request.send()
                request.onload = () => {
                    const weather = request.response
                    const for5Days = () => {
                        const date = new Date();
                        const ts = date.getTime();
                        const fiveDays = ts - (5 * 24 * 60 * 60 * 1000);
                        return new Date(fiveDays)
                    }
                    const last5daysObject = weather.filter(e => { var d = new Date(e.time); return d.getDate() > for5Days().getDate() })
                    const temp = last5daysObject.filter(t => t.type === 'temperature')
                    const final = temp.reduce((op, { value, type, unit, time, place }) => {
                        const [date] = time.split('T', 1)
                        op[date] = op[date] || { value: Infinity, type, unit, time, place }
                        op[date].value = op[date].value > value ? value : op[date].value
                        return op
                    }, {})
 
                    console.log(Object.values(final))
                    const theModel = dataModel(Object.values(final))
                    const theView = view(window)
                    theView.update(theModel)
                }
            }
 */

        }

    </script>
</head>





<body onload="init()">
    <div id='base'>
        <h1>Weather Wep Page</h1>
        <h2>First Query</h2>
        <table id='weather' style="display: inline-block;" ,>
            <thead>
                <tr>
                    <td>value</td>
                    <td>type</td>
                    <td>unit</td>
                    <td>time</td>
                    <td>place</td>
                </tr>
            </thead>
            <tbody id='weather_data'></tbody>
        </table>


        <table id='forecast' style="float: right;">
            <thead>
                <tr>
                    <td>from</td>
                    <td>to</td>
                    <td>type</td>
                    <td>unit</td>
                    <td>time</td>
                    <td>place</td>
                </tr>
            </thead>
            <tbody id='forecast_data'></tbody>
        </table>

        <h2>Second Query</h2>
        <table id='mintemp' style="margin-top: 25px">
            <thead>
                <tr>

                    <td>value</td>
                    <td>type</td>
                    <td>unit</td>
                    <td>time</td>
                    <td>place</td>
                </tr>
            </thead>
            <tbody id='min_temp'></tbody>
        </table>
    </div>

</body>

</html>