<html>

<head>
    <title>Weather Wep Page</title>
    <style>
        td {
            width: 40px;
            height: 40px;
            border: 1px solid black;
        }

        table {
            border: 1px solid black;
            border-spacing: 0;
        }

        h1 {
            color: #FF0000
        }

        h2 {
            color: #6200ff
        }
    </style>

    <script type='module'>


        import view from './view.js'
        import dataModel from './dataModel.js'

        window.init = function () {
            const request = new XMLHttpRequest()
            request.responseType = 'json';

            request.open('GET', 'http://localhost:8080/data')
            request.send()
            request.onload = () => {

                const data = request.response

                request.open('GET', 'http://localhost:8080/forecast')
                request.send()

                request.onload = () => {

                    const forecast = request.response


                    request.open('GET', 'http://localhost:8080/data')
                    request.send()

                    //1.1) first query, •	All data for the latest measurement of weather data
                    var latestDate1 = new Date(Math.max.apply(null, data.map(e => { return new Date(e.time) })));
                    var latestData1 = data.filter(e => { var d = new Date(e.time); return d.getTime() == latestDate1.getTime() })

                    //1.2) first query, •  All data for the latest measurement of weather data of forecast
                    var latestDate2 = new Date(Math.max.apply(null, forecast.map(e => { return new Date(e.time) })));
                    var latestData2 = forecast.filter(e => { var d = new Date(e.time); return d.getTime() == latestDate2.getTime() })


                    request.onload = () => {
                        //2) second query, •  Minimum temperature for the last 5 days
                        const last5Data = request.response
                        const for5Days = () => {
                            const date = new Date();
                            const ts = date.getTime();
                            const fiveDays = ts - (6 * 24 * 60 * 60 * 1000);
                            return new Date(fiveDays)
                        }
                        
                        const last5daysObject = last5Data.filter(e => { var d = new Date(e.time); return d.getDate() > for5Days().getDate() })
                        const temp = last5daysObject.filter(t => t.type === 'temperature')

                        const finalformintemp = temp.reduce((op, { value, type, unit, time, place }) => {
                            const [date] = time.split('T', 1)
                            op[date] = op[date] || { value: Infinity, type, unit, time, place }
                            op[date].value = op[date].value > value ? value : op[date].value
                            return op
                        }, {})

                        //3) third query, •   Maximum temperature for the last 5 days
                        const finalformaxtemp = temp.reduce((op, { value, type, unit, time, place }) => {
                            const [date] = time.split('T', 1) 
                            op[date] = op[date] || { value: -Infinity , type, unit, time, place }
                            op[date].value = op[date].value < value ? value : op[date].value
                            return op
                        }, {})

                        //4) forth query, •   Total precipitation for the last 5 days
                       
                         const pre = for5Days.filter(t => t.type === 'precipitation')
                        const finalfortotalpre = pre.reduce((op, { value, type, unit, time, place }) => {
                            const [date] = time.split('T', 1)
                            op[date] = op[date] || { value, type, unit, time, place }
                           
                            return op
                        }, {}) 
                        



                        const theModel = dataModel(latestData1, latestData2, Object.values(finalformintemp), Object.values(finalformaxtemp),
                            Object.values(finalfortotalpre))
                        const theView = view(window)
                        theView.update(theModel)
                    }

                }
            }

        }



    </script>
</head>





<body onload="init()">
    <div id='base'>
        <h1>Weather Wep Page </h1>
        <h2>First Query</h2>
        <table id='weather' style="display: inline-block;" ,>
            <thead>
                <tr>
                    <td>value</td>
                    <td>type</td>
                    <td>unit</td>
                    <td>time</td>
                    <td>place</td>
                </tr>
            </thead>
            <tbody id='weather_data'></tbody>
        </table>


        <table id='forecast' style="float: right;">
            <thead>
                <tr>
                    <td>from</td>
                    <td>to</td>
                    <td>type</td>
                    <td>unit</td>
                    <td>time</td>
                    <td>place</td>
                </tr>
            </thead>
            <tbody id='forecast_data'></tbody>
        </table>

        <h2>Second Query</h2>
        <table id='mintemp' style="margin-top: 25px">
            <thead>
                <tr>

                    <td>value</td>
                    <td>type</td>
                    <td>unit</td>
                    <td>time</td>
                    <td>place</td>
                </tr>
            </thead>
            <tbody id='min_temp'></tbody>
        </table>


        <h2>Third Query</h2>
        <table id='maxtemp' style="margin-top: 25px">
            <thead>
                <tr>

                    <td>value</td>
                    <td>type</td>
                    <td>unit</td>
                    <td>time</td>
                    <td>place</td>
                </tr>
            </thead>
            <tbody id='max_temp'></tbody>
        </table>


        <h2>Forth Query</h2>
        <table id='totalpre' style="margin-top: 25px">
            <thead>
                <tr>

                    <td>value</td>
                    <td>type</td>
                    <td>unit</td>
                    <td>time</td>
                    <td>place</td>
                </tr>
            </thead>
            <tbody id='total_pre'></tbody>
        </table>
    </div>

</body>

</html>